diff -aur rpm-4.8.1.orig//lib/header.c rpm-4.8.1/lib/header.c
--- rpm-4.8.1.orig//lib/header.c	2010-06-11 08:45:34.000000000 +0000
+++ rpm-4.8.1/lib/header.c	2011-12-22 18:31:06.000000000 +0000
@@ -358,6 +358,9 @@
 		const unsigned char * dataEnd,
 		int regionid)
 {
+    if ((entry != NULL && regionid >= 0) || (entry == NULL && regionid != 0))
+	return -1;
+
     for (; il > 0; il--, pe++) {
 	struct indexEntry_s ie;
 	rpmTagType type;
@@ -822,7 +825,7 @@
 
 	{   int off = ntohl(pe->offset);
 
-	    if (hdrchkData(off))
+	    if (hdrchkData(off) || hdrchkRange(dl, off))
 		goto errxit;
 	    if (off) {
 		size_t nb = REGION_TAG_COUNT;
