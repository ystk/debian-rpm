Description: fix denial of service and possible code execution via
 large region size
Origin: upstream, http://rpm.org/gitweb?p=rpm.git;a=commitdiff;h=472e569562d4c90d7a298080e0052856aa7fa86b
Origin: upstream, http://rpm.org/gitweb?p=rpm.git;a=commitdiff;h=858a328cd0f7d4bcd8500c78faaf00e4f8033df6
Bug-Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=667031

Index: rpm-4.9.0/lib/header.c
===================================================================
--- rpm-4.9.0.orig/lib/header.c	2013-01-17 12:06:53.913112180 -0500
+++ rpm-4.9.0/lib/header.c	2013-01-17 12:06:59.337112319 -0500
@@ -876,13 +876,12 @@
 	    indexEntry newEntry = entry + ril;
 	    int ne = (h->indexUsed - ril);
 	    int rid = entry->info.offset+1;
-	    int rc;
 
 	    /* Load dribble entries from region. */
-	    rc = regionSwab(newEntry, ne, 0, pe+ril, dataStart, dataEnd, rid);
-	    if (rc < 0)
+	    rdlen = regionSwab(newEntry, ne, rdlen, pe+ril,
+				dataStart, dataEnd, rid);
+	    if (rdlen < 0)
 		goto errxit;
-	    rdlen += rc;
 
 	  { indexEntry firstEntry = newEntry;
 	    int save = h->indexUsed;
@@ -904,6 +903,11 @@
 	    h->indexUsed += ne;
 	  }
 	}
+
+	rdlen += REGION_TAG_COUNT;
+
+	if (rdlen != dl)
+	    goto errxit;
     }
 
     h->flags &= ~HEADERFLAG_SORTED;
